<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»™å¥³å®¶éº»å°‡å®¤ - 2026 ç´€éŒ„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+XiaoWei&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ffb7c5;
            --secondary: #fdf6e3;
            --text: #5d4037;
            --win: #ffccd5;
            --loss: #e0e0e0;
            --no-play: #fefae0;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--secondary);
            color: var(--text);
            margin: 0;
            padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0;
            background-image: radial-gradient(#ffb7c5 0.5px, transparent 0.5px);
            background-size: 20px 20px;
            user-select: none;
        }

        .journal-container {
            max-width: 500px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            padding: 20px;
            position: relative;
        }

        .header {
            text-align: center;
            border-bottom: 2px dashed var(--primary);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .header h1 {
            font-family: 'ZCOOL+XiaoWei', serif;
            font-size: 2rem;
            color: #d81b60;
            margin: 0;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 20px;
        }

        .calendar-day {
            aspect-ratio: 1;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            border: 1px solid #eee;
        }

        .calendar-day:active { transform: scale(0.9); }
        .day-label { font-weight: bold; margin-bottom: 2px; }
        .day-val { font-size: 0.6rem; overflow: hidden; text-overflow: ellipsis; max-width: 100%; white-space: nowrap; }

        .bg-win { background-color: var(--win) !important; border: 1.5px solid #ff8fa3; color: #d81b60; }
        .bg-loss { background-color: var(--loss) !important; border: 1.5px solid #bdbdbd; color: #616161; }
        .bg-no-play { background-color: var(--no-play) !important; border: 1.5px solid #e9edc9; color: #827717; }

        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(3px);
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 24px;
            width: 90%;
            max-width: 400px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .player-chip {
            padding: 8px 14px;
            border: 1.5px solid var(--primary);
            border-radius: 20px;
            margin: 4px;
            display: inline-block;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .player-chip.selected {
            background-color: var(--primary);
            color: white;
        }

        .input-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 8px 0;
            padding: 10px 14px;
            background: #fdfdfd;
            border: 1px solid #f0f0f0;
            border-radius: 12px;
        }

        .stats-card {
            background: white;
            border-radius: 18px;
            padding: 18px;
            margin-bottom: 20px;
            border-left: 6px solid var(--primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
        }

        input[type="number"] {
            width: 80px;
            border: 1.5px solid #eee;
            border-radius: 8px;
            padding: 6px;
            text-align: center;
            outline: none;
            font-weight: 500;
        }

        .toggle-sign-btn {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            transition: all 0.1s;
        }
        /* æ­£æ•¸æŒ‰éˆ•æ¨£å¼ (è´éŒ¢) */
        .sign-plus { background-color: #ffccd5; color: #d81b60; border: 1px solid #ff8fa3; }
        /* è² æ•¸æŒ‰éˆ•æ¨£å¼ (è¼¸éŒ¢) */
        .sign-minus { background-color: #616161; color: white; border: 1px solid #424242; }

        .btn-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--primary);
            color: white;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: none;
            z-index: 200;
        }
    </style>
</head>
<body>

<div class="journal-container">
    <div class="header">
        <h1>ä»™å¥³å®¶éº»å°‡å®¤</h1>
        <p class="text-sm opacity-60">2026 å¹´åº¦æ‰‹å¸³ç´€éŒ„</p>
    </div>

    <div class="stats-card">
        <div class="flex justify-between items-center mb-4">
            <button onclick="changeMonth(-1)" class="p-2">â—€</button>
            <h2 id="currentMonthLabel" class="font-bold text-lg">2026å¹´ 1æœˆ</h2>
            <button onclick="changeMonth(1)" class="p-2">â–¶</button>
        </div>
        <div class="grid grid-cols-2 gap-4 text-center">
            <div class="bg-pink-50 rounded-xl py-2">
                <p class="text-xs text-gray-500">æœ¬æœˆç¸½å°‡æ•¸</p>
                <p id="monthTotalGames" class="text-xl font-bold">0</p>
            </div>
            <div class="bg-gray-50 rounded-xl py-2">
                <p class="text-xs text-gray-500">æˆ‘çš„ç¸½è¼¸è´</p>
                <p id="monthMyProfit" class="text-xl font-bold">0</p>
            </div>
        </div>
    </div>

    <div class="calendar-grid" id="calendar"></div>

    <div class="stats-card">
        <h3 class="font-bold border-b mb-3 pb-1 flex items-center">
            <span class="mr-2">ğŸ§§</span> æœ¬æœˆå¥½å‹æˆ°ç¸¾æ¦œ
        </h3>
        <div id="friendsStats" class="text-sm space-y-2"></div>
    </div>

    <div class="flex flex-col items-center gap-2 mt-10">
        <p class="text-center text-xs text-gray-400">è³‡æ–™å·²è‡ªå‹•å‚™ä»½æ–¼æœ¬åœ°å„²å­˜ç©ºé–“</p>
        <button onclick="exportData()" class="text-[10px] text-pink-300 underline">å‚™ä»½æ•¸æ“š (JSON)</button>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 id="modalDateLabel" class="font-bold text-lg mb-4 text-center text-pink-600">æ—¥æœŸ</h2>
        
        <div class="mb-5">
            <label class="block text-sm font-bold mb-2">ä»Šæ—¥å°‡æ•¸ï¼š</label>
            <div class="flex items-center gap-6 justify-center bg-pink-50 p-4 rounded-2xl">
                <button class="btn-circle" onclick="adjustGames(-1)">-</button>
                <span id="editGames" class="text-2xl font-bold w-10 text-center">0</span>
                <button class="btn-circle" onclick="adjustGames(1)">+</button>
            </div>
        </div>

        <div class="mb-5">
            <label class="block text-sm font-bold mb-2">åƒèˆ‡ç‰Œå’– (è¤‡é¸)ï¼š</label>
            <div id="playerSelector" class="flex flex-wrap justify-center"></div>
        </div>

        <div id="profitInputs" class="space-y-2 mb-5"></div>

        <div class="bg-gray-50 p-4 rounded-xl">
            <div class="flex justify-between text-xs mb-1 text-gray-500">
                <span>å°è²» (å°‡ Ã— 200):</span>
                <span id="calcTableFee">0</span>
            </div>
            <div class="flex justify-between font-bold text-base">
                <span>å¹³å¸³æ ¡é©— (æ‡‰ç‚º0):</span>
                <span id="calcBalance">0</span>
            </div>
            <p id="balanceMsg" class="text-[10px] text-right mt-1"></p>
        </div>

        <div class="grid grid-cols-2 gap-3 mt-6">
            <button onclick="closeModal()" class="py-3 bg-gray-100 text-gray-600 rounded-full font-bold">å–æ¶ˆ</button>
            <button onclick="saveRecord()" class="py-3 bg-pink-400 text-white rounded-full font-bold shadow-md">å„²å­˜ç´€éŒ„</button>
        </div>
        <button onclick="deleteRecord()" class="w-full mt-6 text-xs text-red-300">âŒ åˆªé™¤æœ¬æ—¥ç´€éŒ„</button>
    </div>
</div>

<div id="toast" class="toast">å·²å„²å­˜</div>

<script>
    const STORAGE_KEY = 'mahjong_records_v1_2026';
    const PLAYERS = ["æˆ‘", "èœèœ", "ç¾çª", "æŸšæŸš", "äº®äº®", "Willy", "å°æ¯”", "å®—ç©", "è˜Šè˜Š", "å…¶ä»–"];
    
    // ä½¿ç”¨ç‰©ä»¶è¿½è¹¤æ¯å€‹äººçš„æ­£è² ç‹€æ…‹ï¼Œè§£æ±º 0 ç„¡æ³•åˆ¤æ–·æ­£è² çš„å•é¡Œ
    let playerSigns = {}; // { "æˆ‘": 1, "èœèœ": -1 }

    let currentYear = 2026;
    let currentMonth = 0; 
    let records = {};
    let editingDate = '';
    let tempRecord = {};

    function loadData() {
        try {
            const saved = localStorage.getItem(STORAGE_KEY);
            records = saved ? JSON.parse(saved) : {};
        } catch (e) { records = {}; }
    }

    function init() {
        loadData();
        renderCalendar();
        renderPlayerSelector();
        document.getElementById('editModal').onclick = closeModal;
    }

    function renderCalendar() {
        const calendar = document.getElementById('calendar');
        calendar.innerHTML = '';
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        document.getElementById('currentMonthLabel').innerText = `${currentYear}å¹´ ${currentMonth + 1}æœˆ`;

        for (let i = 0; i < firstDay; i++) calendar.innerHTML += '<div></div>';

        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const record = records[dateStr];
            let bgClass = '', valDisplay = '';

            if (record) {
                const myProfit = record.profits["æˆ‘"] || 0;
                if (record.players.includes("æˆ‘")) {
                    bgClass = (myProfit > 0) ? 'bg-win' : (myProfit < 0 ? 'bg-loss' : 'bg-no-play');
                    valDisplay = myProfit > 0 ? `+${myProfit}` : (myProfit === 0 ? 'Â±0' : myProfit);
                } else if (record.games > 0) {
                    bgClass = 'bg-no-play';
                    valDisplay = 'æœ‰å±€';
                }
            }
            calendar.innerHTML += `
                <div class="calendar-day ${bgClass}" onclick="openModal('${dateStr}')">
                    <span class="day-label">${day}</span>
                    <span class="day-val">${valDisplay}</span>
                </div>
            `;
        }
        updateMonthlyStats();
    }

    function updateMonthlyStats() {
        let monthGames = 0, myProfit = 0, friendsTotal = {};
        PLAYERS.forEach(p => friendsTotal[p] = 0);

        Object.keys(records).forEach(date => {
            const d = new Date(date);
            if (d.getFullYear() === currentYear && d.getMonth() === currentMonth) {
                const rec = records[date];
                monthGames += (rec.games || 0);
                Object.keys(rec.profits).forEach(p => {
                    const val = parseInt(rec.profits[p]) || 0;
                    friendsTotal[p] += val;
                    if (p === "æˆ‘") myProfit += val;
                });
            }
        });

        document.getElementById('monthTotalGames').innerText = monthGames;
        const myProfitEl = document.getElementById('monthMyProfit');
        myProfitEl.innerText = (myProfit > 0 ? '+' : '') + myProfit;
        myProfitEl.style.color = myProfit > 0 ? '#d81b60' : (myProfit < 0 ? '#757575' : '#5d4037');

        const friendsDiv = document.getElementById('friendsStats');
        friendsDiv.innerHTML = '';
        PLAYERS.filter(p => p !== "æˆ‘").forEach(p => {
            const pVal = friendsTotal[p] || 0;
            friendsDiv.innerHTML += `
                <div class="flex justify-between items-center py-1 border-b border-pink-50 last:border-0">
                    <span class="text-gray-600">${p}</span>
                    <span class="font-bold ${pVal > 0 ? 'text-pink-500' : (pVal < 0 ? 'text-gray-400' : 'text-gray-300')}">
                        ${pVal > 0 ? '+' : ''}${pVal}
                    </span>
                </div>
            `;
        });
    }

    function changeMonth(delta) {
        currentMonth += delta;
        if (currentMonth < 0) { currentMonth = 11; currentYear--; }
        if (currentMonth > 11) { currentMonth = 0; currentYear++; }
        renderCalendar();
    }

    function renderPlayerSelector() {
        const container = document.getElementById('playerSelector');
        container.innerHTML = PLAYERS.map(p => `
            <span class="player-chip" id="chip-${p}" onclick="togglePlayer('${p}')">${p}</span>
        `).join('');
    }

    function openModal(date) {
        editingDate = date;
        document.getElementById('modalDateLabel').innerText = date.replace(/-/g, ' / ');
        const record = records[date] || { games: 0, players: [], profits: {} };
        tempRecord = JSON.parse(JSON.stringify(record));
        
        // åˆå§‹åŒ–æ­£è² è™Ÿç‹€æ…‹
        PLAYERS.forEach(p => {
            const val = tempRecord.profits[p] || 0;
            // è®€å–ç¾æœ‰è³‡æ–™ï¼Œå¦‚æœå°æ–¼ 0 å‰‡è¨­ç‚ºè² ï¼Œå¦å‰‡è¨­ç‚ºæ­£
            playerSigns[p] = val < 0 ? -1 : 1;
        });

        updateModalUI();
        document.getElementById('editModal').style.display = 'flex';
    }

    function updateModalUI() {
        document.getElementById('editGames').innerText = tempRecord.games;
        PLAYERS.forEach(p => {
            const chip = document.getElementById(`chip-${p}`);
            tempRecord.players.includes(p) ? chip.classList.add('selected') : chip.classList.remove('selected');
        });

        const inputDiv = document.getElementById('profitInputs');
        inputDiv.innerHTML = tempRecord.players.map(p => {
            const absVal = Math.abs(tempRecord.profits[p] || 0);
            const isNegative = playerSigns[p] === -1;
            return `
            <div class="input-group">
                <span class="font-bold text-pink-700">${p}</span>
                <div class="flex items-center gap-3">
                    <button onclick="toggleSign('${p}')" 
                        class="toggle-sign-btn ${isNegative ? 'sign-minus' : 'sign-plus'}">
                        ${isNegative ? 'è¼¸ -' : 'è´ +'}
                    </button>
                    <input type="number" 
                        value="${absVal === 0 ? '' : absVal}" 
                        placeholder="0"
                        oninput="updateProfit('${p}', this.value)" 
                        onfocus="this.select()"
                        inputmode="numeric">
                </div>
            </div>
            `;
        }).join('');
        calculateBalance();
    }

    function toggleSign(player) {
        playerSigns[player] = playerSigns[player] === 1 ? -1 : 1;
        const absVal = Math.abs(tempRecord.profits[player] || 0);
        tempRecord.profits[player] = absVal * playerSigns[player];
        updateModalUI();
    }

    function togglePlayer(player) {
        if (tempRecord.players.includes(player)) {
            tempRecord.players = tempRecord.players.filter(p => p !== player);
            delete tempRecord.profits[player];
        } else {
            tempRecord.players.push(player);
            tempRecord.profits[player] = 0;
            playerSigns[player] = -1; // é è¨­æ–°å¢çš„äººå…ˆè¨­ç‚ºã€Œè¼¸ã€ï¼Œå› ç‚ºé€šå¸¸å…ˆè¨˜è¼¸å®¶
        }
        updateModalUI();
    }

    function updateProfit(player, valStr) {
        const absVal = parseInt(valStr) || 0;
        tempRecord.profits[player] = absVal * playerSigns[player];
        calculateBalance();
    }

    function adjustGames(delta) {
        tempRecord.games = Math.max(0, tempRecord.games + delta);
        document.getElementById('editGames').innerText = tempRecord.games;
        calculateBalance();
    }

    function calculateBalance() {
        const tableFee = (tempRecord.games || 0) * 200;
        const totalProfit = Object.values(tempRecord.profits).reduce((a, b) => a + (parseInt(b) || 0), 0);
        const balance = tableFee + totalProfit;
        document.getElementById('calcTableFee').innerText = tableFee;
        const balEl = document.getElementById('calcBalance');
        balEl.innerText = balance;
        const msgEl = document.getElementById('balanceMsg');
        if (balance === 0) {
            balEl.style.color = '#10b981';
            msgEl.innerText = 'âœ… å¸³ç›®å¹³é½Š';
        } else {
            balEl.style.color = '#ef4444';
            msgEl.innerText = balance > 0 ? `å¤šå‡º ${balance}` : `ç¼ºå°‘ ${Math.abs(balance)}`;
        }
    }

    function closeModal() { document.getElementById('editModal').style.display = 'none'; }

    function saveRecord() {
        const tableFee = tempRecord.games * 200;
        const totalProfit = Object.values(tempRecord.profits).reduce((a, b) => a + b, 0);
        if (tableFee + totalProfit !== 0 && tempRecord.games > 0) {
            if (!confirm('å¸³ç›®å°šæœªå¹³é½Šï¼Œç¢ºå®šè¦å„²å­˜å—ï¼Ÿ')) return;
        }
        records[editingDate] = tempRecord;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
        renderCalendar();
        closeModal();
        const toast = document.getElementById('toast');
        toast.style.display = 'block';
        setTimeout(() => toast.style.display = 'none', 2000);
    }

    function deleteRecord() {
        if (confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')) {
            delete records[editingDate];
            localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
            renderCalendar();
            closeModal();
        }
    }

    function exportData() {
        const dataStr = JSON.stringify(records, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `mahjong_backup.json`;
        a.click();
    }

    window.onload = init;
</script>
</body>
</html>