<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>éº»å°‡æ—¥æ›†ï¼ˆåŒæ­¥åŸºç¤ç‰ˆï¼‰</title>

  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-pink-50 p-4">

<h1 class="text-2xl font-bold mb-4">ğŸ€„ éº»å°‡ç´€éŒ„ï¼ˆæ—¥æ›†ï¼‰</h1>

<!-- æ–°å¢äººå -->
<div class="mb-4 flex gap-2">
  <input id="newPlayerInput"
         class="border px-2 py-1 rounded"
         placeholder="æ–°å¢äººå">
  <button onclick="addPlayer()"
          class="bg-pink-300 px-3 py-1 rounded">
    æ–°å¢
  </button>
</div>

<!-- ç©å®¶é¸æ“‡ -->
<div class="mb-4">
  <select id="playerSelect" class="border px-2 py-1 rounded"></select>
</div>

<!-- è¨˜å¸³ -->
<div class="mb-6 flex gap-2">
  <input id="amountInput"
         type="number"
         class="border px-2 py-1 rounded"
         placeholder="é‡‘é¡">
  <button onclick="saveRecord()"
          class="bg-green-300 px-3 py-1 rounded">
    è¨˜éŒ„ä»Šå¤©
  </button>
</div>

<!-- æ—¥æ›†ç´€éŒ„ -->
<div class="bg-white p-3 rounded shadow">
  <h2 class="font-bold mb-2">ğŸ“… ç´€éŒ„</h2>
  <div id="calendar"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ================= Firebase ================= */
const firebaseConfig = {
  apiKey: "AIzaSyBByyCj9jUyTpV96GQUUcOhJk81tNsxNt8",
  authDomain: "mahjong-calendar-2870.firebaseapp.com",
  projectId: "mahjong-calendar-2870",
  storageBucket: "mahjong-calendar-2870.firebasestorage.app",
  messagingSenderId: "169815645370",
  appId: "1:169815645370:web:052e7e239460a4d05ab683"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================= è³‡æ–™ ================= */
let players = [];
let records = {};
let currentPlayer = "";

/* ================= é›²ç«¯ ================= */
async function loadFromCloud() {
  const doc = await db.collection("mahjong").doc("shared").get();
  if (doc.exists) {
    const d = doc.data();
    players = d.players || [];
    records = d.records || {};
  }
}

function saveToCloud() {
  db.collection("mahjong").doc("shared").set({
    players,
    records
  });
}

function listenCloud() {
  db.collection("mahjong").doc("shared")
    .onSnapshot(doc => {
      if (doc.exists) {
        const d = doc.data();
        players = d.players || [];
        records = d.records || {};
        renderAll();
      }
    });
}

/* ================= äººå ================= */
function renderPlayers() {
  const select = document.getElementById("playerSelect");
  select.innerHTML = "";

  players.forEach(p => {
    select.add(new Option(p, p));
  });

  if (!currentPlayer && players.length) {
    currentPlayer = players[0];
  }
  select.value = currentPlayer;
  select.onchange = e => currentPlayer = e.target.value;
}

function addPlayer() {
  const input = document.getElementById("newPlayerInput");
  const name = input.value.trim();
  if (!name) return;
  if (players.includes(name)) return;

  players.push(name);
  input.value = "";
  saveToCloud();
}

/* ================= è¨˜å¸³ ================= */
function saveRecord() {
  const amount = Number(document.getElementById("amountInput").value);
  if (!currentPlayer || isNaN(amount)) return;

  const today = new Date().toISOString().slice(0, 10);
  if (!records[today]) records[today] = {};
  records[today][currentPlayer] = amount;

  document.getElementById("amountInput").value = "";
  saveToCloud();
}

function renderCalendar() {
  const div = document.getElementById("calendar");
  div.innerHTML = "";

  Object.keys(records)
    .sort()
    .reverse()
    .forEach(date => {
      const d = document.createElement("div");
      d.className = "border-b py-1";
      d.textContent =
        date + "ï¼š" +
        Object.entries(records[date])
          .map(([p, v]) => `${p} ${v}`)
          .join("ï¼Œ");
      div.appendChild(d);
    });
}

/* ================= åˆå§‹åŒ– ================= */
function renderAll() {
  renderPlayers();
  renderCalendar();
}

async function init() {
  await loadFromCloud();
  renderAll();
  listenCloud();
}

init();
</script>

</body>
</html>
