<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>éº»å°‡æ—¥æ›†ç´€éŒ„</title>

  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-pink-50 p-4">

<h1 class="text-2xl font-bold mb-4">ğŸ€„ éº»å°‡ç´€éŒ„ï¼ˆæ—¥æ›†ï¼‰</h1>

<!-- åˆ†é æŒ‰éˆ• -->
<div class="mb-4 flex gap-2">
  <button onclick="showPage('calendar')" class="bg-pink-300 px-3 py-1 rounded">
    ğŸ“… æ—¥æ›†
  </button>
  <button onclick="showPage('manage')" class="bg-gray-200 px-3 py-1 rounded">
    ğŸ“Š çµ±è¨ˆ / äººå“¡
  </button>
</div>

<!-- ================= æ—¥æ›†é¦–é  ================= -->
<div id="calendarPage">

  <!-- ç©å®¶é¸æ“‡ + è¨˜å¸³ -->
  <div class="mb-4 flex flex-wrap gap-2 items-center">
    <select id="playerSelect" class="border px-2 py-1 rounded"></select>
    <input id="amountInput" type="number" class="border px-2 py-1 rounded" placeholder="é‡‘é¡">
    <button onclick="saveRecord()" class="bg-green-300 px-3 py-1 rounded">
      è¨˜éŒ„ä»Šå¤©
    </button>
  </div>

  <!-- æ—¥æ›†ç´€éŒ„ -->
  <div class="bg-white rounded shadow p-3">
    <h2 class="font-bold mb-2">ğŸ“… ç´€éŒ„</h2>
    <div id="calendar"></div>
  </div>

</div>

<!-- ================= çµ±è¨ˆ / äººå“¡ ================= -->
<div id="managePage" class="hidden">

  <!-- æ–°å¢ç©å®¶ -->
  <div class="mb-4 flex gap-2">
    <input id="newPlayerName" class="border px-2 py-1 rounded" placeholder="æ–°å¢äººå">
    <button onclick="addPlayer()" class="bg-pink-300 px-3 py-1 rounded">æ–°å¢</button>
  </div>

  <!-- åˆªé™¤ç©å®¶ -->
  <div class="mb-6 flex gap-2">
    <select id="deletePlayerSelect" class="border px-2 py-1 rounded"></select>
    <button onclick="deletePlayer()" class="bg-red-300 px-3 py-1 rounded">åˆªé™¤æˆå“¡</button>
  </div>

  <!-- çµ±è¨ˆ -->
  <div class="bg-white rounded shadow p-3">
    <h2 class="font-bold mb-2">ğŸ“Š çµ±è¨ˆ</h2>
    <div id="statsContainer" class="space-y-1 text-sm"></div>
  </div>

</div>

<!-- ================= Firebase ================= -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ---------- Firebase ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyBByyCj9jUyTpV96GQUUcOhJk81tNsxNt8",
  authDomain: "mahjong-calendar-2870.firebaseapp.com",
  projectId: "mahjong-calendar-2870",
  storageBucket: "mahjong-calendar-2870.firebasestorage.app",
  messagingSenderId: "169815645370",
  appId: "1:169815645370:web:052e7e239460a4d05ab683"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ---------- è³‡æ–™ ---------- */
let players = ["ä»™å¥³"];
let records = {};
let currentPlayer = "";

/* ---------- åˆ†é  ---------- */
function showPage(page) {
  document.getElementById("calendarPage").classList.toggle("hidden", page !== "calendar");
  document.getElementById("managePage").classList.toggle("hidden", page !== "manage");
}

/* ---------- é›²ç«¯ ---------- */
async function loadData() {
  const doc = await db.collection("mahjong").doc("shared").get();
  if (doc.exists) {
    const data = doc.data();
    players = data.players || players;
    records = data.records || {};
  }
}

function saveToCloud() {
  db.collection("mahjong").doc("shared").set({ players, records });
}

function listenCloudChanges() {
  db.collection("mahjong").doc("shared").onSnapshot(doc => {
    if (doc.exists) {
      const data = doc.data();
      players = data.players || players;
      records = data.records || {};
      renderAll();
    }
  });
}

/* ---------- ç©å®¶ ---------- */
function renderPlayerSelector() {
  const select = document.getElementById("playerSelect");
  const del = document.getElementById("deletePlayerSelect");
  select.innerHTML = "";
  del.innerHTML = "";

  players.forEach(p => {
    select.add(new Option(p, p));
    del.add(new Option(p, p));
  });

  if (!currentPlayer && players.length) currentPlayer = players[0];
  select.value = currentPlayer;
  select.onchange = e => currentPlayer = e.target.value;
}

function addPlayer() {
  const input = document.getElementById("newPlayerName");
  const name = input.value.trim();
  if (!name || players.includes(name)) return;
  players.push(name);
  input.value = "";
  saveToCloud();
}

function deletePlayer() {
  const name = document.getElementById("deletePlayerSelect").value;
  if (!confirm(`ç¢ºå®šåˆªé™¤ ${name}ï¼Ÿ`)) return;

  players = players.filter(p => p !== name);
  Object.keys(records).forEach(d => {
    delete records[d][name];
    if (Object.keys(records[d]).length === 0) delete records[d];
  });

  if (currentPlayer === name) currentPlayer = players[0] || "";
  saveToCloud();
}

/* ---------- è¨˜å¸³ ---------- */
function saveRecord() {
  const amount = Number(document.getElementById("amountInput").value);
  if (!currentPlayer || isNaN(amount)) return;

  const today = new Date().toISOString().slice(0, 10);
  if (!records[today]) records[today] = {};
  records[today][currentPlayer] = amount;

  document.getElementById("amountInput").value = "";
  saveToCloud();
}

function renderCalendar() {
  const div = document.getElementById("calendar");
  div.innerHTML = "";

  Object.keys(records).sort().reverse().forEach(date => {
    const d = document.createElement("div");
    d.className = "border-b py-1";
    d.textContent = date + "ï¼š" +
      Object.entries(records[date]).map(([p, v]) => `${p} ${v}`).join("ï¼Œ");
    div.appendChild(d);
  });
}

/* ---------- çµ±è¨ˆ ---------- */
function calculatePlayDays() {
  const days = {};
  players.forEach(p => days[p] = 0);
  Object.values(records).forEach(day => {
    players.forEach(p => {
      if (day[p] !== undefined) days[p]++;
    });
  });
  return days;
}

function renderStats() {
  const c = document.getElementById("statsContainer");
  c.innerHTML = "";
  const days = calculatePlayDays();

  players.forEach(p => {
    let total = 0;
    Object.values(records).forEach(day => {
      if (day[p] !== undefined) total += Number(day[p]);
    });
    const div = document.createElement("div");
    div.textContent = `${p}ï½œç¸½è¼¸è´ ${total}ï½œä¾†æ‰“ ${days[p]} å¤©`;
    c.appendChild(div);
  });
}

/* ---------- åˆå§‹åŒ– ---------- */
function renderAll() {
  renderPlayerSelector();
  renderCalendar();
  renderStats();
}

async function init() {
  await loadData();
  renderAll();
  listenCloudChanges();
  showPage("calendar"); // âœ… é¦–é é¡¯ç¤ºæ—¥æ›†
}

init();
</script>

</body>
</html>
